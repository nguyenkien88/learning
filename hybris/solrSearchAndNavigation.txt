mainly indexing and searching product (storefront and backoffice)
solr is free/full-text search, attribute nao duoc indexed => luc search se duoc included
say, I want use name, price, description of Product to be indexed so I can search/facet refine based on that properties using solr
can start solr server indepent without start hybris: ant startSolrServer
van theo flow Controller, Facade...nhu binh thuong, chi la dung service related to solr to search in the solr server
log: hybris\log\solr\instances\default\solr.log

terms
  indexed type: e.g. Product
  facet: grouping for continue navigation e.g. price facet
  relevance: su lien quan
  boots??
  search query vs free text search query

features
  search query template
    easy for customize e.g. remove fields like images from the suggestions template to improve the performance or change the sorting to draw the attention to certain products
    template for search query? built-in grouping, sorting, query - can customize
  manage search configuration
  
architecture
  solrfacetsearch extention: facet search and navigation
  solrserver extension: standalone solr server - recommend only for dev, in production should create separate solr server
  solrfacetsearchbackoffice extention
  
implementation
  installation
    support versions (expecially for production): https://tinyurl.com/y4po6llw
	configuration: standalone mode vs cloud mode - https://tinyurl.com/y57fglgl
	  solrserver/project.properties - can override in local.properties
	  e.g. solrserver.instances.default.autostart=true => auto start with the platform
	  solrserver.instances.default.mode=standalone vs solrserver.instances.cloud.mode=cloud
	  endpoint url: impex
  
  configuration
    under hybris/config/solr - default generated when build for the first time
	configsets: diferent configuration for different index types e.g. default configsets, backoffice config set
	schema.xml: the structure of the index
	solrconfig.xml
	config for instance, ant tasks for solr: https://tinyurl.com/y39halsd
    
  indexing function
    say, when add new attribute to a type, should/should not include it in the indexing process
	say, send data (type attribute) to solr for indexing
	  normal attributes: send directly to solr
	  custom attibutes: modify, check before send to solr - using provider (thuc chat normal attributes also use the default ModelPropertyFieldValueProvider)
	  e.g. viet custom provider to search/show how many days a product will be online from now (data not existing directly in db): http://javainsimpleway.com/value-provider-in-solr-with-example/
    indexing types
	  full index: deleted all existing index then re-index
	    direct mode: not rollback - row nao duoc index roi ko bi rollback, row nao fail thi thoi (lay version truoc)
		2 phases mode: rollback - In this mode,Solr creates one extra core as a temporary core only for indexing, once indexing is success then it will be swapped with original core
	  update index: only index for modified documents
	  delete index: remove indexed documents
	solr.impex (priority vs .properties??)
	  SolrServerConfig: embedded (removed in 6.x) vs standalone vs cloud e.g. codengaiIndex
	  SolrEndpointUrl(belong to a SolrServerConfig) e.g http://localhost:8983/solr
	  SolrIndexConfig: batch size, number of thread, index mode (DIRECT or TWO_PHASE) 
	  SolrIndexedType: type to be indexed e.g. Product, sorting reference e.g. sortRef1, sortRef2
	  SolrSearchConfig: page size e.g 20
	  SolrFacetSearchConfig: link all above configs along with currencies, languages - then link to the site - BaseSite link 1 to 1 with SolrFacetSearchConfig
	  SolrValueRangeSet/SolrValueRange e.g. priceRangeGBP
	  SolrIndexedProperty e.g. goodsmile-globalProductType: define properties to be indexed, how these properties should be indexed
	    provider: translate properties which solr can not understand during indexing
		facet[default=true]: make an property is facet indexing
	  SolrIndexerQuery e.g. goodsmile-global-fullQuery: define the data source for the indexing process using flexible search query
	  SolrSort e.g. sortRef5 (code=price-asc): define the insert order
	  SolrSortField
	  SolrIndexerCronJob: define cronjob to run the indexing e.g. cronJob for the SolrFacetSearchConfig which full/update code
	solr_en.impex: localize for solr.impex
    solrtrigger.impex: schedule for solr indexing job	
    indexing process - using cron job
	
  searching function
    strategies
	  LegacyFacetSearchStrategy: mainly use configuration for condition and params, less flexible
	  DefaultFacetSearchStrategy: condition and parms are set directly in the query object => flexible tuy context
	create query: DefaultFacetSearchService
	  say creating and populating the search query
	  new SearchQuery(facetSearchConfig, indexedType);//or some other methods 
      SearchQuery object: all attributes will be the info when converting to sorl query
        queryFields: q=value
	    filterQueryFields: fq=value - not effect the score
	    facetFields: fields for facet purpose
	    orderFields: fields for sorting purpose
	    Some of the query parameters in the search query object will only be used together with the new search strategy. When using the legacy search strategy, that information will be taken directly from the configuration and not from the search query object. The affected parameters are:
          default query operator
          filter queries
          free text search queries
          facets (not facet values)
          fields to be included in the response
          boosts	
	search: in strategies
	  context: FacetSearchContext e.g. get config, get query...contains useful info during the search
	  convert the hybris search query to solr query: FreeTextQueryBuilder vs SolrQueryConverter (with populators and post processors-5.4) vs FacetSearchListener
	  	FreeTextQueryBuilder
        SolrQueryConverter
		  populators
		  SolrQueryPostProcessor (deprecated from 5.7): provides a direct access to the query right before performing search on solr's index e.g. modify the query before search on apache solr
	      => change to FacetSearchListener
		FacetSearchListener: same function with to SolrQueryPostProcessor, used in 6.x
	  actual search: solrClient.query()
	process result after search  
	  


  autosuggest and spellcheck
  sort providers
  listeners 
    for indexing: before/after batch, before/after whole indexing process
	and searching process: https://tinyurl.com/y5ew7zaf
    

use case for kd: e.g. https://goodsmile-global.local:9002/kadokawaacceleratorstorefront/?sort=productPrivilegeFlg&q=%3AproductPrivilegeFlg
  using rest request for searching
    e.g. yq=*:*&q={!boost}(%2B{!lucene+v%3D$yq})&fq=allCategories_string_mv:CATEGORY\-ROOT&fq=(catalogId:"GSLS_GL\-PRODUCTCATALOG"+AND+catalogVersion:"Online")&sort=productPrivilegeFlg_boolean+desc&start=0&rows=40&facet.field=salesMethod_string&facet.field=price_jpy_string&facet.field=allPromotions_string_mv&facet.field=categoryPath_string_mv&facet.field=allCategories_string_mv&facet.field=displaySite_string_mv&facet.field=category_string_mv&facet.field=stockLevelStatus_string&facet=true&facet.sort=count&facet.mincount=1&facet.limit=50&fl=score,*
  GslsCategoryProductListGridComponentController
    calls productSearchFacade.categorySearch(searchQuery, pagingInfo)
      which calls productSearchService.searchAgain(searchQuery, pagingInfo)
	    which calls DefaultSolrProductSearchService.doSearch(searchQuery, pagingInfo) 
		  execute the search
		    call DefaultFacetSearchService.search()
			  which calls DefaultFacetSearchStrategy.search
			return solrSearchResponse which contains SolrDocuments result
		  then call defaultVisibilityFilteringSolrSearchResponseConverter to covert the response
		  which use many populators to convert the search response (note:a converter e.g. defaultVisibilityFilteringSolrSearchResponseConverter inherits all populators from parent e.g. abstractPopulatingConverter)
	  then call gslsProductCategorySearchPageConverter to convert the result
	    which calls gslsProductCategorySearchPagePopulator
		  which calls defaultCommerceSearchResultProductConverter
		    which calls gslsSearchResultProductPopulator
			
  GslsSolrQueryPostProcessor - solrQueryPostProcessors
    is used in defaultSolrQueryConverter
	  which is used in DefaultFacetSearchService (5.4 only)
	  in 6.7 defaultSolrQueryConverter is used in legacyFacetSearchStrategy (vs defaultFacetSearchStrategy - in DefaultFacetSearchService)
	    => add more criteria to the search e.g. hanbaiEndDateDouble
		=> change the DefaultFacetSearchStrategy to legacyFacetSearchStrategy
	  change to legacy true?
	    goodsmile-globalIndex => searchConfiguration => legacymode = true
  kd query sample: fill in to the query field of solr server: solrserver/server123 - decode url before search
  {!boost}(+{!lucene v=$yq})&fq=allCategories_string_mv:CATEGORY\-ROOT&fq=(catalogId:"GSLS_GL\-PRODUCTCATALOG" AND catalogVersion:"Online")&fq=displaySite_string_mv:(goodsmile-global OR true)&fq=(stockLevelStatus_string:inStock) OR (hanbaiStartDateDouble_double:([1569408536267 TO *]) OR hatsubaiStartDateDouble_double:([1569408536267 TO *]))&fq=hanbaiEndDateDouble_double:([1569408536267 TO *])&fq=hatsubaiEndDateDouble_double:([1569408536267 TO *])&sort=postingDate_sortable_date desc,postingDate_sortable_date desc&start=0&rows=40&facet.field=salesMethod_string&facet.field=price_jpy_string&facet.field=allPromotions_string_mv&facet.field=categoryPath_string_mv&facet.field=allCategories_string_mv&facet.field=displaySite_string_mv&facet.field=category_string_mv&facet.field=stockLevelStatus_string&facet=true&facet.sort=count&facet.mincount=1&facet.limit=50&fl=score,*
			
reference
  hybris help
  https://hybrismart.com/2017/07/13/explaining-sap-hybrissolr-relevance-ranking-for-phrase-queries/
  https://hybrismart.com/2017/08/16/hybris-solr-query-builders-and-search-relevance/